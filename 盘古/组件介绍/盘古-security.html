<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.14" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.52" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://vuepress-theme-hope-docs-demo.netlify.app/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/%E7%9B%98%E5%8F%A4-security.html"><meta property="og:title" content="Feign模块"><meta property="og:description" content="Feign模块 如何使用 引用如下模块 xml java java 注解介绍 java 技术原理 java java java java java java image.pngimage.png"><meta property="og:type" content="article"><meta property="og:image" content="http://pangu.kingtsoft.com/pangu-facade/assets/image1.8ca381d0.png"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-11-18T07:25:41.000Z"><meta property="article:author" content="Cotton Eye Joe"><meta property="article:modified_time" content="2024-11-18T07:25:41.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Feign模块","image":["http://pangu.kingtsoft.com/pangu-facade/assets/image1.8ca381d0.png"],"dateModified":"2024-11-18T07:25:41.000Z","author":[{"@type":"Person","name":"Cotton Eye Joe","url":"https://github.com/ToDreamr"}]}</script><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><script async src="https://umami.zhenxin.me/script.js" data-website-id="a799e189-cf7e-4f5a-ac98-71de364f3637"></script><script src="https://cdn.armoe.cn/static/js/autoGray.js"></script><title>Feign模块</title><meta name="description" content="Feign模块 如何使用 引用如下模块 xml java java 注解介绍 java 技术原理 java java java java java java image.pngimage.png">
    <link rel="preload" href="/assets/style-DuvwdHTW.css" as="style"><link rel="stylesheet" href="/assets/style-DuvwdHTW.css">
    <link rel="modulepreload" href="/assets/app-TmqSDitQ.js"><link rel="modulepreload" href="/assets/盘古-security.html-BNSYl7Ck.js">
    <link rel="prefetch" href="/assets/index.html-CFhogwoB.js" as="script"><link rel="prefetch" href="/assets/portfolio.html-BxVteSEA.js" as="script"><link rel="prefetch" href="/assets/友链.html-C5Yy13PO.js" as="script"><link rel="prefetch" href="/assets/index.html-B984vThc.js" as="script"><link rel="prefetch" href="/assets/disable.html-C2YOeozI.js" as="script"><link rel="prefetch" href="/assets/encrypt.html-DLwcfHs0.js" as="script"><link rel="prefetch" href="/assets/layout.html-B-ye_h4s.js" as="script"><link rel="prefetch" href="/assets/markdown.html-BznAMy0W.js" as="script"><link rel="prefetch" href="/assets/page.html-Cs21IQYM.js" as="script"><link rel="prefetch" href="/assets/友链.html-raC_u1Wm.js" as="script"><link rel="prefetch" href="/assets/index.html-CpypAr2P.js" as="script"><link rel="prefetch" href="/assets/index.html-BrC_NUuz.js" as="script"><link rel="prefetch" href="/assets/Otome Games Analysis.html-DcTONphA.js" as="script"><link rel="prefetch" href="/assets/在生活中的一些思考问题.html-BUJ4mZ8X.js" as="script"><link rel="prefetch" href="/assets/学习计划.html-DZv_pjah.js" as="script"><link rel="prefetch" href="/assets/Idea.html-DQvV8xX9.js" as="script"><link rel="prefetch" href="/assets/10月.html-lzGqs3d4.js" as="script"><link rel="prefetch" href="/assets/依赖相关.html-CZmsW12S.js" as="script"><link rel="prefetch" href="/assets/word.html-chRMUopq.js" as="script"><link rel="prefetch" href="/assets/数字马力.html-OD4Jc7bm.js" as="script"><link rel="prefetch" href="/assets/7.0病历.html-Dj1nuK-0.js" as="script"><link rel="prefetch" href="/assets/Oracle数据库部分代码测试不通过.html-C98zucvH.js" as="script"><link rel="prefetch" href="/assets/SQL日志排查记录的工作流程.html-CSZ0MjQG.js" as="script"><link rel="prefetch" href="/assets/kemer病历部架构整理.html-BgdKrD4g.js" as="script"><link rel="prefetch" href="/assets/事务分析.html-CFwRrPzh.js" as="script"><link rel="prefetch" href="/assets/如何在工作当中书写需要的SQL.html-B1pMuj5D.js" as="script"><link rel="prefetch" href="/assets/工作流程.html-WyFbYxxi.js" as="script"><link rel="prefetch" href="/assets/开发规范和知识文档.html-BoXJs-3h.js" as="script"><link rel="prefetch" href="/assets/异常SQL数据查询.html-EOtg5wiJ.js" as="script"><link rel="prefetch" href="/assets/质控项-修改代码(SQL).html-Co5eAkUk.js" as="script"><link rel="prefetch" href="/assets/金唐软件.html-CFjCXWJk.js" as="script"><link rel="prefetch" href="/assets/金唐软件部分代码分析.html-_VLRBwED.js" as="script"><link rel="prefetch" href="/assets/Ubuntu系统各软件.html-C7JJkfHp.js" as="script"><link rel="prefetch" href="/assets/RabbitMQ.html-Dw3KignD.js" as="script"><link rel="prefetch" href="/assets/病历-临床部门后端实习.html-x8hHLZRr.js" as="script"><link rel="prefetch" href="/assets/高并发编程.html-B7Od-Dqf.js" as="script"><link rel="prefetch" href="/assets/JVM内存模型.html-str4ZJKB.js" as="script"><link rel="prefetch" href="/assets/内存管理.html-DoI0DYYB.js" as="script"><link rel="prefetch" href="/assets/类与类加载.html-CkfoeH-m.js" as="script"><link rel="prefetch" href="/assets/设计模式系列 - 设计模式（一）面向对象设计原则.html-IyVKPnsx.js" as="script"><link rel="prefetch" href="/assets/设计模式系列 - 设计模式（三）结构型.html-exR171fs.js" as="script"><link rel="prefetch" href="/assets/设计模式系列 - 设计模式（二）创建型.html-DotyHGhC.js" as="script"><link rel="prefetch" href="/assets/设计模式系列 - 设计模式（四）行为型.html-DuscxS-X.js" as="script"><link rel="prefetch" href="/assets/Cpp.html-DFcjkRw5.js" as="script"><link rel="prefetch" href="/assets/index.html-PmrsYTop.js" as="script"><link rel="prefetch" href="/assets/baz.html-B14OHDXJ.js" as="script"><link rel="prefetch" href="/assets/index.html-b0d1hDEY.js" as="script"><link rel="prefetch" href="/assets/ray.html-DyrNoDCi.js" as="script"><link rel="prefetch" href="/assets/KafKa.html-C0tddeAu.js" as="script"><link rel="prefetch" href="/assets/RabbitMQ.html-BagOXJAw.js" as="script"><link rel="prefetch" href="/assets/Redis(消息模式).html-Bh1YjezP.js" as="script"><link rel="prefetch" href="/assets/Redis(直连模式).html-27s6hCSO.js" as="script"><link rel="prefetch" href="/assets/minio.html-15s3DzN0.js" as="script"><link rel="prefetch" href="/assets/mongodb.html-BHhz7rdB.js" as="script"><link rel="prefetch" href="/assets/nacos集成.html-_W92HURR.js" as="script"><link rel="prefetch" href="/assets/ES模块.html-cVa8rfWs.js" as="script"><link rel="prefetch" href="/assets/Prometheus模块.html-B9zhv2Uq.js" as="script"><link rel="prefetch" href="/assets/sharding模块.html-CJ_2ctfS.js" as="script"><link rel="prefetch" href="/assets/分布式事务系列.html-Dam42lAJ.js" as="script"><link rel="prefetch" href="/assets/多线程事务.html-BIk5SHPd.js" as="script"><link rel="prefetch" href="/assets/数据源模块.html-DasOVfAL.js" as="script"><link rel="prefetch" href="/assets/Https模块.html-CRqUledA.js" as="script"><link rel="prefetch" href="/assets/Mybatis-Plus.html-CFKMdE9l.js" as="script"><link rel="prefetch" href="/assets/SQL跟踪模块.html-CIKqInmj.js" as="script"><link rel="prefetch" href="/assets/Swagger.html-BQPoX06B.js" as="script"><link rel="prefetch" href="/assets/chat模块.html-BSeu_aX2.js" as="script"><link rel="prefetch" href="/assets/list工作流集成.html-DIQStKHW.js" as="script"><link rel="prefetch" href="/assets/plug组件.html-CbuWvXTO.js" as="script"><link rel="prefetch" href="/assets/xxl-job模块.html-BHQ0Jy0h.js" as="script"><link rel="prefetch" href="/assets/仓盒模块.html-BGVctQPy.js" as="script"><link rel="prefetch" href="/assets/工具类.html-Cn1HrSJh.js" as="script"><link rel="prefetch" href="/assets/延时模块.html-D2FsUmru.js" as="script"><link rel="prefetch" href="/assets/异常模块.html-DaD6rPvr.js" as="script"><link rel="prefetch" href="/assets/控制器排除模块.html-o809dcAH.js" as="script"><link rel="prefetch" href="/assets/框架日志模块.html-Bkk0GlTK.js" as="script"><link rel="prefetch" href="/assets/盘古.html-DERWeGkn.js" as="script"><link rel="prefetch" href="/assets/盘古security模块(含授权).html-CYFgg1E-.js" as="script"><link rel="prefetch" href="/assets/缓存模块.html-CdQ9R__H.js" as="script"><link rel="prefetch" href="/assets/脱敏和持久层加解密.html-DVQzT6CQ.js" as="script"><link rel="prefetch" href="/assets/认证模块.html-B25bJ3yE.js" as="script"><link rel="prefetch" href="/assets/配置文件加解密模块.html-DfEhlWjP.js" as="script"><link rel="prefetch" href="/assets/nacos.html-B423p-iY.js" as="script"><link rel="prefetch" href="/assets/日志.html-CrzOT-Fw.js" as="script"><link rel="prefetch" href="/assets/熔断.html-ChBJvY-L.js" as="script"><link rel="prefetch" href="/assets/认证.html-CwkmVQSh.js" as="script"><link rel="prefetch" href="/assets/路由.html-Dq3aMhdP.js" as="script"><link rel="prefetch" href="/assets/限流.html-B6rxt4oJ.js" as="script"><link rel="prefetch" href="/assets/通用链路跟踪模块.html-C2YN2hSw.js" as="script"><link rel="prefetch" href="/assets/鹰眼模块.html-DxAMVjlK.js" as="script"><link rel="prefetch" href="/assets/index.html-sARh2OIG.js" as="script"><link rel="prefetch" href="/assets/index.html-D5VbzMTu.js" as="script"><link rel="prefetch" href="/assets/并发编程.html-BFxnFUEV.js" as="script"><link rel="prefetch" href="/assets/类图-UML.html-DwIBCHZD.js" as="script"><link rel="prefetch" href="/assets/SpringCloud 1.html-C1XN71Pm.js" as="script"><link rel="prefetch" href="/assets/SpringCloud 2.html-DAtz4Amh.js" as="script"><link rel="prefetch" href="/assets/SpringCloud 3.html-Cevfs-eK.js" as="script"><link rel="prefetch" href="/assets/index.html-CYHGlbQO.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-BUMB4BLf.js" as="script"><link rel="prefetch" href="/assets/SQL优化.html-DN_sRe_n.js" as="script"><link rel="prefetch" href="/assets/一次SQL优化记录.html-Bh5XVvGx.js" as="script"><link rel="prefetch" href="/assets/多版本并发控制事务.html-RQNwljqo.js" as="script"><link rel="prefetch" href="/assets/Oracle.html-1jZwYLZg.js" as="script"><link rel="prefetch" href="/assets/Redis.html-d4wcYnK4.js" as="script"><link rel="prefetch" href="/assets/数之和.html-DZFYXeeY.js" as="script"><link rel="prefetch" href="/assets/有序数组的平方.html-BOHI7vp6.js" as="script"><link rel="prefetch" href="/assets/移除元素.html-Cmd24nfD.js" as="script"><link rel="prefetch" href="/assets/螺旋矩阵.html-T1icxynC.js" as="script"><link rel="prefetch" href="/assets/链表篇.html-BYaXULiP.js" as="script"><link rel="prefetch" href="/assets/长度最小的数组.html-C7snmJ5N.js" as="script"><link rel="prefetch" href="/assets/index.html-7rILkgil.js" as="script"><link rel="prefetch" href="/assets/快速排序和堆排序.html-ZtF9wmuY.js" as="script"><link rel="prefetch" href="/assets/二分法.html-BijuUzI3.js" as="script"><link rel="prefetch" href="/assets/哈希篇.html-BG6uM9DY.js" as="script"><link rel="prefetch" href="/assets/链表.html-CwP7y5Ir.js" as="script"><link rel="prefetch" href="/assets/Docker.html-B2sgCiBF.js" as="script"><link rel="prefetch" href="/assets/数据结构图示.html-DxB96Ei5.js" as="script"><link rel="prefetch" href="/assets/实例化Node.html-ZbcHkGmU.js" as="script"><link rel="prefetch" href="/assets/对象间的关系.html-W-pYFWnG.js" as="script"><link rel="prefetch" href="/assets/ThreadLocal.html-D6wemK4P.js" as="script"><link rel="prefetch" href="/assets/关键字.html-TdPMErrz.js" as="script"><link rel="prefetch" href="/assets/404.html-Cpm13-JQ.js" as="script"><link rel="prefetch" href="/assets/index.html-CxR8ULZJ.js" as="script"><link rel="prefetch" href="/assets/index.html-BCeKSjhT.js" as="script"><link rel="prefetch" href="/assets/index.html-D9KPj6qQ.js" as="script"><link rel="prefetch" href="/assets/index.html-FyrOxmdi.js" as="script"><link rel="prefetch" href="/assets/index.html-C6T7x-oJ.js" as="script"><link rel="prefetch" href="/assets/index.html-BSCU9o1g.js" as="script"><link rel="prefetch" href="/assets/index.html-CnKr6-je.js" as="script"><link rel="prefetch" href="/assets/index.html-DiLbUlOG.js" as="script"><link rel="prefetch" href="/assets/index.html-DxvnBYUl.js" as="script"><link rel="prefetch" href="/assets/index.html-CV9hgv-g.js" as="script"><link rel="prefetch" href="/assets/index.html-DLYAOzyd.js" as="script"><link rel="prefetch" href="/assets/index.html-DBY1UYd7.js" as="script"><link rel="prefetch" href="/assets/index.html-D0jcBBMZ.js" as="script"><link rel="prefetch" href="/assets/index.html-KBqVbZXI.js" as="script"><link rel="prefetch" href="/assets/index.html-Sc99Z7NP.js" as="script"><link rel="prefetch" href="/assets/index.html-Cy-4WUtu.js" as="script"><link rel="prefetch" href="/assets/index.html-DYOqxnb5.js" as="script"><link rel="prefetch" href="/assets/index.html-CdoMT6rk.js" as="script"><link rel="prefetch" href="/assets/index.html-COQ2GxEG.js" as="script"><link rel="prefetch" href="/assets/index.html-DHDanH2D.js" as="script"><link rel="prefetch" href="/assets/index.html-DNZQajfn.js" as="script"><link rel="prefetch" href="/assets/index.html-CnANjUEL.js" as="script"><link rel="prefetch" href="/assets/index.html-DAtMlu9r.js" as="script"><link rel="prefetch" href="/assets/index.html-BzpxpFZb.js" as="script"><link rel="prefetch" href="/assets/index.html-BFwgjvDj.js" as="script"><link rel="prefetch" href="/assets/index.html-CuT7uSM0.js" as="script"><link rel="prefetch" href="/assets/index.html-CdHny7gG.js" as="script"><link rel="prefetch" href="/assets/index.html-BCcPlr2g.js" as="script"><link rel="prefetch" href="/assets/index.html-DxRjNECp.js" as="script"><link rel="prefetch" href="/assets/index.html-B7NjrE12.js" as="script"><link rel="prefetch" href="/assets/index.html-D93p1IMG.js" as="script"><link rel="prefetch" href="/assets/index.html-CumxJxNE.js" as="script"><link rel="prefetch" href="/assets/index.html-CEvdz964.js" as="script"><link rel="prefetch" href="/assets/index.html-_5k8rdMz.js" as="script"><link rel="prefetch" href="/assets/index.html-Bg_fhPJ2.js" as="script"><link rel="prefetch" href="/assets/index.html-aupX84wW.js" as="script"><link rel="prefetch" href="/assets/index.html-C9CqhrfQ.js" as="script"><link rel="prefetch" href="/assets/index.html-DAPXys0Q.js" as="script"><link rel="prefetch" href="/assets/index.html-DCWDPt__.js" as="script"><link rel="prefetch" href="/assets/index.html-C0G1KY8j.js" as="script"><link rel="prefetch" href="/assets/index.html-309mQZs0.js" as="script"><link rel="prefetch" href="/assets/index.html-CY96oIji.js" as="script"><link rel="prefetch" href="/assets/index.html-BI6NBIuh.js" as="script"><link rel="prefetch" href="/assets/index.html-Bi7cJKTe.js" as="script"><link rel="prefetch" href="/assets/index.html-CcCkJG_q.js" as="script"><link rel="prefetch" href="/assets/index.html-PuHo7rgE.js" as="script"><link rel="prefetch" href="/assets/index.html-DmG4s-2g.js" as="script"><link rel="prefetch" href="/assets/index.html-DmpZYpm4.js" as="script"><link rel="prefetch" href="/assets/index.html-Ff89vAya.js" as="script"><link rel="prefetch" href="/assets/index.html-BuKpQW3r.js" as="script"><link rel="prefetch" href="/assets/index.html-DujI-0eF.js" as="script"><link rel="prefetch" href="/assets/index.html-ptbegCIg.js" as="script"><link rel="prefetch" href="/assets/index.html-RHWCqdfC.js" as="script"><link rel="prefetch" href="/assets/index.html-96VfiVD9.js" as="script"><link rel="prefetch" href="/assets/index.html-CQxbyZVW.js" as="script"><link rel="prefetch" href="/assets/index.html-CIyQMUVY.js" as="script"><link rel="prefetch" href="/assets/index.html-MRmoJVYv.js" as="script"><link rel="prefetch" href="/assets/index.html-BZ9CWZsa.js" as="script"><link rel="prefetch" href="/assets/index.html-WTqnwQlc.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-GXRgw7eJ.js" as="script"><link rel="prefetch" href="/assets/index-BNnYFWcz.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/秒速５センチメートル.svg" alt><!----><!----></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="雨山"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-user-graduate" style=""></span><!--]-->雨山<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/portfolio.html" aria-label="主页"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span><!--]-->主页<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/demo/" aria-label="文档和笔记"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><!--]-->文档和笔记<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/%E5%8F%8B%E9%93%BE.html" aria-label="朋友们"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-user-graduate" style=""></span><!--]-->朋友们<!----></a></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/Todreamr/Dr.Magic" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-color-mode-switch" id="color-mode-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" name="auto" style="display:none;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" name="dark" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" name="light" style="display:block;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span><span class="vp-sidebar-title">后端理论</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-check-square" style=""></span><span class="vp-sidebar-title">盘古</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">中间件</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">数据源</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">组件介绍</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/chat%E6%A8%A1%E5%9D%97.html" aria-label="chat模块"><!---->chat模块<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/%E5%BB%B6%E6%97%B6%E6%A8%A1%E5%9D%97.html" aria-label="Delay模块"><!---->Delay模块<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/%E7%9B%98%E5%8F%A4-security.html" aria-label="Feign模块"><!---->Feign模块<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/Https%E6%A8%A1%E5%9D%97.html" aria-label="Https模块"><!---->Https模块<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/Mybatis-Plus.html" aria-label="MybatisPlus模块"><!---->MybatisPlus模块<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/plug%E7%BB%84%E4%BB%B6.html" aria-label="plug组件"><!---->plug组件<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/SQL%E8%B7%9F%E8%B8%AA%E6%A8%A1%E5%9D%97.html" aria-label="SQL跟踪模块"><!---->SQL跟踪模块<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/Swagger.html" aria-label="Swagger模块"><!---->Swagger模块<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/xxl-job%E6%A8%A1%E5%9D%97.html" aria-label="xxl-job模块"><!---->xxl-job模块<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/%E4%BB%93%E7%9B%92%E6%A8%A1%E5%9D%97.html" aria-label="仓盒模块"><!---->仓盒模块<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/%E5%B7%A5%E5%85%B7%E7%B1%BB.html" aria-label="工具类"><!---->工具类<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/%E5%BC%82%E5%B8%B8%E6%A8%A1%E5%9D%97.html" aria-label="异常模块"><!---->异常模块<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/%E6%8E%A7%E5%88%B6%E5%99%A8%E6%8E%92%E9%99%A4%E6%A8%A1%E5%9D%97.html" aria-label="控制器排除模块"><!---->控制器排除模块<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/%E7%BC%93%E5%AD%98%E6%A8%A1%E5%9D%97.html" aria-label="本地缓存模块(工具)"><!---->本地缓存模块(工具)<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/%E6%A1%86%E6%9E%B6%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97.html" aria-label="框架日志模块"><!---->框架日志模块<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/%E7%9B%98%E5%8F%A4security%E6%A8%A1%E5%9D%97(%E5%90%AB%E6%8E%88%E6%9D%83).html" aria-label="盘古security模块(含授权)"><!---->盘古security模块(含授权)<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/list%E5%B7%A5%E4%BD%9C%E6%B5%81%E9%9B%86%E6%88%90.html" aria-label="网关-限流"><!---->网关-限流<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/%E8%84%B1%E6%95%8F%E5%92%8C%E6%8C%81%E4%B9%85%E5%B1%82%E5%8A%A0%E8%A7%A3%E5%AF%86.html" aria-label="脱敏&amp;持久层加解密"><!---->脱敏&amp;持久层加解密<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/%E7%9B%98%E5%8F%A4.html" aria-label="自研的分布式框架-盘古"><!---->自研的分布式框架-盘古<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/%E8%AE%A4%E8%AF%81%E6%A8%A1%E5%9D%97.html" aria-label="认证模块"><!---->认证模块<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%8A%A0%E8%A7%A3%E5%AF%86%E6%A8%A1%E5%9D%97.html" aria-label="配置文件加解密模块"><!---->配置文件加解密模块<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">网关</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">鹰眼框架</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">思考</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-check-square" style=""></span><span class="vp-sidebar-title">帮助</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Feign模块</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://github.com/ToDreamr" target="_blank" rel="noopener noreferrer">Cotton Eye Joe</a></span><span property="author" content="Cotton Eye Joe"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-11-18T07:25:41.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 11 分钟</span><meta property="timeRequired" content="PT11M"></span><!----><!----></div><hr></div><!----><!----><div class="theme-hope-content"><h1 id="feign模块" tabindex="-1"><a class="header-anchor" href="#feign模块"><span>Feign模块</span></a></h1><blockquote><h4 id="如何使用" tabindex="-1"><a class="header-anchor" href="#如何使用"><span>如何使用</span></a></h4></blockquote><p>引用如下模块</p><p><strong>xml</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>&lt;dependency&gt;</span></span>
<span class="line"><span>  &lt;groupId&gt;com.kingtsoft.pangu&lt;/groupId&gt;</span></span>
<span class="line"><span>  &lt;artifactId&gt;pangu-springcloud-feign&lt;/artifactId&gt;</span></span>
<span class="line"><span>  &lt;version&gt;${pangu.version}&lt;/version&gt;</span></span>
<span class="line"><span>&lt;/dependency&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>    定义feignClient(保证Client所在包中有api或者feign这个路径)，例如com.kingtsoft.pangu.frame.simple.test.api</span></span>
<span class="line"><span>com.kingtsoft.pangu.frame.simple.test.feign</span></span>
<span class="line"><span>必须要有PgFeignClient标记才会初始化为客户端</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>java</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>@FeignResultClient</span></span>
<span class="line"><span>@PgFeignClient(clientCode=&quot;pangu-frame-simple&quot;, basePath=&quot;pangu-xdev&quot;, url=&quot;https://127.0.0.1:10240/pangu-xdev&quot;, loadBalance=false)</span></span>
<span class="line"><span>public interface  TestCallAnoServiceApi {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    String SUF =&quot;/pub/test&quot;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @RequestMapping(value= SUF +&quot;/testAnoCall?a=1&amp;b=3&quot;, method= RequestMethod.POST)</span></span>
<span class="line"><span>    String doSomething(@RequestBody OisRegSchedule abc);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>    使用如下，直接注入TestCallAnoServiceApi</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>java</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>private void   testCall() {</span></span>
<span class="line"><span>    log.info(&quot;doCall&quot;);</span></span>
<span class="line"><span>    OisRegSchedule oisRegSchedule =newOisRegSchedule();</span></span>
<span class="line"><span>    oisRegSchedule.setScheduleSn(1L);</span></span>
<span class="line"><span>    String abc = testCallAnoServiceApi.doSomething( oisRegSchedule);</span></span>
<span class="line"><span>    System.out.println(abc);</span></span>
<span class="line"><span>    log.info(&quot;end&quot;);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注解介绍</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>PgFeignClient</span></span>
<span class="line"><span>    url：直接声明请求地址，若为域名，请把loadBalance标记为false，否则会把域名当</span></span>
<span class="line"><span>作负载标记去识别。并且支持使用${}的方式获取配置文件的配置。</span></span>
<span class="line"><span>    clientCode：客户端代码，最好唯一。在没有url的情况下，会作为负载标记前缀</span></span>
<span class="line"><span>    encoder：编码配置，默认SPRING自带模式，可选GSON及FORM模式</span></span>
<span class="line"><span>    (注意，根据feign机制，数据返回并不会使用这里配置的encoder，除非是异步feign客户端)</span></span>
<span class="line"><span>    configuration：配置自定义配置，支持feign客户端配置，拦截器配置，编码，解码等，如下为案例</span></span>
<span class="line"><span>    basePath：基础路径，在负载且不用网关的情况下。路径解析可能只到端口。使用此属性会在端口之后配置个基础路径。</span></span>
<span class="line"><span>    loadBalance：是否开启负载均衡模式</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>java</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>@Configuration</span></span>
<span class="line"><span>public class  FeignClientConfiguration {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>public Feign.Builder pgFeignBuild() {</span></span>
<span class="line"><span>        Feign.Builder builder =getFeignBuildDefault();</span></span>
<span class="line"><span>buildInterceptors(builder);</span></span>
<span class="line"><span>        String wn = environment.getProperty(&quot;feign.write-nulls&quot;);</span></span>
<span class="line"><span>boolean   writeNulls = StringUtils.hasText(wn) &amp;&amp; boolean  .parseboolean  (wn);</span></span>
<span class="line"><span>// 使用fastjson作为feign的消息转换器</span></span>
<span class="line"><span>        ObjectFactory&lt;HttpMessageConverters&gt; feignObjectFactory = PgFeignUtil.initFeignNewConverters(messageConverters, writeNulls);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>return builder</span></span>
<span class="line"><span>        .contract(contract)</span></span>
<span class="line"><span>        .encoder(newSpringEncoder(feignObjectFactory))</span></span>
<span class="line"><span>        .decoder(newSpringDecoder(feignObjectFactory, customizers));</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>public Feign.Builder pgFeignGsonBuild() {</span></span>
<span class="line"><span>        Feign.Builder builder =getFeignBuildDefault();</span></span>
<span class="line"><span>buildInterceptors(builder);</span></span>
<span class="line"><span>return builder</span></span>
<span class="line"><span>        .contract(contract)</span></span>
<span class="line"><span>        .encoder(newGsonEncoder())</span></span>
<span class="line"><span>        .decoder(newGsonDecoder());</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>public Feign.Builder pgFeignFormBuild() {</span></span>
<span class="line"><span>        Feign.Builder builder =getFeignBuildDefault();</span></span>
<span class="line"><span>buildInterceptors(builder);</span></span>
<span class="line"><span>        String wn = environment.getProperty(&quot;feign.write-nulls&quot;);</span></span>
<span class="line"><span>boolean   writeNulls = StringUtils.hasText(wn) &amp;&amp; boolean  .parseboolean  (wn);</span></span>
<span class="line"><span>// 使用fastjson作为feign的消息转换器</span></span>
<span class="line"><span>        ObjectFactory&lt;HttpMessageConverters&gt; feignObjectFactory = PgFeignUtil.initFeignNewConverters(messageConverters, writeNulls);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>return builder</span></span>
<span class="line"><span>        .contract(contract)</span></span>
<span class="line"><span>        .encoder(newSpringFormEncoder(newSpringEncoder(feignObjectFactory)))</span></span>
<span class="line"><span>        .decoder(newSpringDecoder(feignObjectFactory, customizers));</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private Feign.Builder getFeignBuildDefault() {</span></span>
<span class="line"><span>// 因为scope为prototype，每次获取bean都会重新创建一个新对象</span></span>
<span class="line"><span>return beanFactory.getBean(&quot;feignBuilder&quot;, Feign.Builder.class);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>#此注解用于处理返回值信息</span></span>
<span class="line"><span>FeignResultClient：</span></span>
<span class="line"><span>    value：返回值处理器类</span></span>
<span class="line"><span>    coverMethod：处理器的方法</span></span>
<span class="line"><span>    postfix：只处理标记处理的后缀</span></span>
<span class="line"><span>此注解标记的类下的方法或者方法的返回值会经过处理类，奖处理类后的结果再返回给调用方，</span></span>
<span class="line"><span>这样feign定义就可以直接定义实际的值部分内容。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><h4 id="技术原理" tabindex="-1"><a class="header-anchor" href="#技术原理"><span>技术原理</span></a></h4></blockquote><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>    首先是feign客户端的扫描，通过自定义扫描，对路径带有api及feign的BeanDefinition</span></span>
<span class="line"><span>进行了扫描。再去这些BeanDefinition判断是否存在自定义的PgFeignClient注解</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>java</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>protected ClassPathScanningCandidateComponentProvider getScanner() {</span></span>
<span class="line"><span>returnnewClassPathScanningCandidateComponentProvider(false, this.environment) {</span></span>
<span class="line"><span>        @Override</span></span>
<span class="line"><span>protectedboolean  isCandidateComponent(@NonNull MetadataReader metadataReader) {</span></span>
<span class="line"><span>            Optional&lt;String&gt; target = metadataReader.getAnnotationMetadata().getAnnotationTypes().stream().filter(</span></span>
<span class="line"><span>                sn -&gt; sn.equals(PgFeignClient.class.getName())</span></span>
<span class="line"><span>            ).findAny();</span></span>
<span class="line"><span>return target.isPresent();</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        @Override</span></span>
<span class="line"><span>protectedboolean  isCandidateComponent(@NonNull AnnotatedBeanDefinition beanDefinition) {</span></span>
<span class="line"><span>return beanDefinition.getMetadata().isInterface() &amp;&amp;!beanDefinition.getMetadata().isAnnotation();</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    };</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ClassLoader classLoader = Thread.currentThread().getContextClassLoader();</span></span>
<span class="line"><span>ClassPathScanningCandidateComponentProvider scanner =getScanner();</span></span>
<span class="line"><span>scanner.setResourceLoader(this.resourceLoader);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Set&lt;BeanDefinition&gt; beanDefinitions =new LinkedHashSet&lt;&gt;();</span></span>
<span class="line"><span>for (String pkg : PKG_ARR) {</span></span>
<span class="line"><span>    Set&lt;BeanDefinition&gt; beanDefinitions2 = scanner.findCandidateComponents(pkg);</span></span>
<span class="line"><span>    beanDefinitions.addAll(beanDefinitions2);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>    默认加入了对okhttp的支持，使用的okhttpclient作为调用客户端，拥有队列线程池，轻松写并发</span></span>
<span class="line"><span>拥有Interceptors等特性。并且根据注解配置，自动判断是否生成负载客户端。</span></span>
<span class="line"><span>    以下为自动化配置类初始化内容</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>java</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>package com.kingtsoft.pangu.springcloud.feign;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>/**</span></span>
<span class="line"><span> * Title: &lt;br&gt;</span></span>
<span class="line"><span> * Description: &lt;br&gt;</span></span>
<span class="line"><span> * Company: KingTang &lt;br&gt;</span></span>
<span class="line"><span> *</span></span>
<span class="line"><span> * @author 金炀</span></span>
<span class="line"><span> * @version 1.0</span></span>
<span class="line"><span> */</span></span>
<span class="line"><span>@Import({FeignClientsConfiguration.class, FeignConfiguration.class, PgFeignClientConfiguration.class })</span></span>
<span class="line"><span>@ConditionalOnClass(Feign.class)</span></span>
<span class="line"><span>@AutoConfigureBefore({org.springframework.cloud.openfeign.FeignAutoConfiguration.class})</span></span>
<span class="line"><span>@AutoConfigureAfter(name= {&quot;com.kingtsoft.pangu.springcloud.nacos.NacosAutoConfiguration&quot;})</span></span>
<span class="line"><span>@Configuration</span></span>
<span class="line"><span>public class  FeignAutoConfigurationimplementsEnvironmentAware {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /** 由于引入PgFeignClientConfiguration的生命周期比预计的早，所以这里需要手动绑定，不然会发现注入的类无法被绑定 */</span></span>
<span class="line"><span>privatestatic PgFeignOkHttpProperties pgFeignOkHttpProperties =newPgFeignOkHttpProperties();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>privatestatic LoadBalancerClientsProperties balancerClientsProperties =newLoadBalancerClientsProperties();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Bean</span></span>
<span class="line"><span>    @Scope(&quot;prototype&quot;)</span></span>
<span class="line"><span>public AsyncFeign.AsyncBuilder&lt;?&gt; asyncFeignBuilder(Retryer retryer) {</span></span>
<span class="line"><span>return AsyncFeign.asyncBuilder().retryer(retryer);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Bean</span></span>
<span class="line"><span>    @ConditionalOnMissingBean(HttpMessageConverters.class)</span></span>
<span class="line"><span>public HttpMessageConverters messageConverters(ObjectProvider&lt;HttpMessageConverter&lt;?&gt;&gt; converters) {</span></span>
<span class="line"><span>returnnewHttpMessageConverters(converters.orderedStream().collect(Collectors.toList()));</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Bean</span></span>
<span class="line"><span>    @ConditionalOnMissingBean(FeignResultCoverRegister.class)</span></span>
<span class="line"><span>public FeignResultCoverRegister feignResultCoverRegister() {</span></span>
<span class="line"><span>returnnewFeignResultCoverRegister();</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Bean</span></span>
<span class="line"><span>public OkHttpLogInterceptor okHttpLogInterceptor() {</span></span>
<span class="line"><span>returnnewOkHttpLogInterceptor();</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Bean</span></span>
<span class="line"><span>public PgFeignProperties pgFeignProperties(Environment environment) {</span></span>
<span class="line"><span>        BindResult&lt;PgFeignProperties&gt; ret = Binder.get(environment)</span></span>
<span class="line"><span>                .bind(PgFeignProperties.PREFIX, PgFeignProperties.class);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        PgFeignProperties pgFeignProperties =newPgFeignProperties();</span></span>
<span class="line"><span>try {</span></span>
<span class="line"><span>if (ret.get() !=null) {</span></span>
<span class="line"><span>                pgFeignProperties = ret.get();</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        } catch (Exception ignore) {}</span></span>
<span class="line"><span>return pgFeignProperties;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Bean</span></span>
<span class="line"><span>    @ConditionalOnWebApplication</span></span>
<span class="line"><span>    @ConditionalOnMissingBean(FeignRequestInterceptor.class)</span></span>
<span class="line"><span>public FeignRequestInterceptor feignRequestInterceptor(PgFeignProperties pgFeignProperties) {</span></span>
<span class="line"><span>returnnewFeignRequestInterceptor(pgFeignProperties);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Bean</span></span>
<span class="line"><span>public OkHttpResultInterceptor okHttpResultInterceptor(FeignResultCoverRegister feignResultCoverRegister) {</span></span>
<span class="line"><span>returnnewOkHttpResultInterceptor(feignResultCoverRegister);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Bean</span></span>
<span class="line"><span>public OkHttpCusUrlInterceptor okHttpCusUrlInterceptor() {</span></span>
<span class="line"><span>returnnewOkHttpCusUrlInterceptor();</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// 这个bean是为了兼容老的一些写法</span></span>
<span class="line"><span>    @Bean(&quot;pgFeignBuild&quot;)</span></span>
<span class="line"><span>    @Primary</span></span>
<span class="line"><span>public Feign.Builder pgFeignBuild(Contract contract,</span></span>
<span class="line"><span>                                      @Qualifier(&quot;feignBuilder&quot;) Feign.Builder builder,</span></span>
<span class="line"><span>                                      @Qualifier(&quot;okHttpFeignClient&quot;) Client okHttpClient,</span></span>
<span class="line"><span>                                      ObjectFactory&lt;HttpMessageConverters&gt; messageConverters,</span></span>
<span class="line"><span>                                      ObjectProvider&lt;HttpMessageConverterCustomizer&gt; customizers,</span></span>
<span class="line"><span>                                      Environment environment) {</span></span>
<span class="line"><span>        String wn = environment.getProperty(&quot;feign.write-nulls&quot;);</span></span>
<span class="line"><span>boolean   writeNulls = StringUtils.hasText(wn) &amp;&amp; boolean  .parseboolean  (wn);</span></span>
<span class="line"><span>// 使用fastjson作为feign的消息转换器</span></span>
<span class="line"><span>        ObjectFactory&lt;HttpMessageConverters&gt; feignObjectFactory = PgFeignUtil.initFeignNewConverters(messageConverters, writeNulls);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>return builder</span></span>
<span class="line"><span>                .client(okHttpClient)</span></span>
<span class="line"><span>                .contract(contract)</span></span>
<span class="line"><span>                .encoder(newSpringEncoder(feignObjectFactory))</span></span>
<span class="line"><span>                .decoder(newSpringDecoder(feignObjectFactory, customizers));</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>private void   setEnvironment(@NonNull Environment environment) {</span></span>
<span class="line"><span>        BindResult&lt;PgFeignOkHttpProperties&gt; ret = Binder.get(environment)</span></span>
<span class="line"><span>                .bind(PgFeignOkHttpProperties.PREFIX, PgFeignOkHttpProperties.class);</span></span>
<span class="line"><span>        BindResult&lt;LoadBalancerClientsProperties&gt; blRet = Binder.get(environment)</span></span>
<span class="line"><span>                .bind(&quot;spring.cloud.loadbalancer&quot;, LoadBalancerClientsProperties.class);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>try {</span></span>
<span class="line"><span>if (ret.get() !=null) {</span></span>
<span class="line"><span>                pgFeignOkHttpProperties = ret.get();</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        } catch (Exception ignore) {}</span></span>
<span class="line"><span>try {</span></span>
<span class="line"><span>if (blRet.get() !=null) {</span></span>
<span class="line"><span>                balancerClientsProperties = blRet.get();</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        } catch (Exception ignore) {}</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Configuration(proxyBeanMethods=false)</span></span>
<span class="line"><span>    @ConditionalOnClass(OkHttpClient.class)</span></span>
<span class="line"><span>protectedstaticclassOkHttpFeignConfiguration {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private OkHttpClient okHttpClient;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        @Bean</span></span>
<span class="line"><span>        @ConditionalOnMissingBean(ConnectionPool.class)</span></span>
<span class="line"><span>public ConnectionPool httpClientConnectionPool(FeignHttpClientProperties httpClientProperties,</span></span>
<span class="line"><span>                                                       OkHttpClientConnectionPoolFactory connectionPoolFactory) {</span></span>
<span class="line"><span>int maxTotalConnections = httpClientProperties.getMaxConnections();</span></span>
<span class="line"><span>long  timeToLive = httpClientProperties.getTimeToLive();</span></span>
<span class="line"><span>            TimeUnit ttlUnit = httpClientProperties.getTimeToLiveUnit();</span></span>
<span class="line"><span>return connectionPoolFactory.create(maxTotalConnections, timeToLive, ttlUnit);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        @Bean(&quot;okHttpLoadBalancerClient&quot;)</span></span>
<span class="line"><span>public Client okHttpLoadBalancerClient(OkHttpLogInterceptor okHttpLogInterceptor,</span></span>
<span class="line"><span>                                               OkHttpResultInterceptor okHttpResultInterceptor,</span></span>
<span class="line"><span>                                               OkHttpCusUrlInterceptor okHttpCusUrlInterceptor,</span></span>
<span class="line"><span>                                               LoadBalancerClient loadBalancerClient,</span></span>
<span class="line"><span>                                               LoadBalancerClientFactory loadBalancerClientFactory) {</span></span>
<span class="line"><span>if (this.okHttpClient ==null) {</span></span>
<span class="line"><span>this.okHttpClient =getOkhttp(okHttpLogInterceptor, okHttpResultInterceptor, okHttpCusUrlInterceptor);</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>returnnewFeignBlockingLoadBalancerClient(this.okHttpClient, loadBalancerClient, loadBalancerClientFactory);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        @ConditionalOnMissingBean</span></span>
<span class="line"><span>        @Bean</span></span>
<span class="line"><span>public LoadBalancerClientFactory loadBalancerClientFactory(ObjectProvider&lt;List&lt;LoadBalancerClientSpecification&gt;&gt; configurations) {</span></span>
<span class="line"><span>            LoadBalancerClientFactory clientFactory =newLoadBalancerClientFactory(balancerClientsProperties);</span></span>
<span class="line"><span>            clientFactory.setConfigurations(configurations.getIfAvailable(Collections::emptyList));</span></span>
<span class="line"><span>return clientFactory;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        @Bean(&quot;okHttpFeignClient&quot;)</span></span>
<span class="line"><span>//        @ConditionalOnMissingBean(OkHttpClient.class)</span></span>
<span class="line"><span>public OkHttpClient okHttpFeignClient(OkHttpLogInterceptor okHttpLogInterceptor,</span></span>
<span class="line"><span>                                              OkHttpResultInterceptor okHttpResultInterceptor,</span></span>
<span class="line"><span>                                              OkHttpCusUrlInterceptor okHttpCusUrlInterceptor) {</span></span>
<span class="line"><span>if (this.okHttpClient ==null) {</span></span>
<span class="line"><span>this.okHttpClient =getOkhttp(</span></span>
<span class="line"><span>                        okHttpLogInterceptor, okHttpResultInterceptor, okHttpCusUrlInterceptor);</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>returnthis.okHttpClient;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private OkHttpClient getOkhttp(OkHttpLogInterceptor okHttpLogInterceptor,</span></span>
<span class="line"><span>                                       OkHttpResultInterceptor okHttpResultInterceptor,</span></span>
<span class="line"><span>                                       OkHttpCusUrlInterceptor okHttpCusUrlInterceptor) {</span></span>
<span class="line"><span>returnnewOkHttpClient(new okhttp3.OkHttpClient.Builder()</span></span>
<span class="line"><span>// 三次握手 + SSL建立耗时</span></span>
<span class="line"><span>                    .connectTimeout(pgFeignOkHttpProperties.getConnectTimeout(), TimeUnit.MILLISECONDS)</span></span>
<span class="line"><span>// 设置读超时</span></span>
<span class="line"><span>                    .readTimeout(pgFeignOkHttpProperties.getReadTimeout(), TimeUnit.MILLISECONDS)</span></span>
<span class="line"><span>// 从发起到结束的总时长</span></span>
<span class="line"><span>                    .callTimeout(pgFeignOkHttpProperties.getCallTimeout(), TimeUnit.MILLISECONDS)</span></span>
<span class="line"><span>// 设置写超时</span></span>
<span class="line"><span>                    .writeTimeout(pgFeignOkHttpProperties.getWriteTimeout(), TimeUnit.MILLISECONDS)</span></span>
<span class="line"><span>                    .sslSocketFactory(SslSocketClient.getSslSocketFactory(), SslSocketClient.getX509TrustManager())</span></span>
<span class="line"><span>                    .hostnameVerifier(SslSocketClient.getHostnameVerifier())</span></span>
<span class="line"><span>// 是否自动重连</span></span>
<span class="line"><span>                    .retryOnConnectionFailure(true)</span></span>
<span class="line"><span>                    .connectionPool(newConnectionPool())</span></span>
<span class="line"><span>                    .addInterceptor(okHttpCusUrlInterceptor)</span></span>
<span class="line"><span>                    .addInterceptor(okHttpLogInterceptor)</span></span>
<span class="line"><span>                    .addInterceptor(okHttpResultInterceptor)</span></span>
<span class="line"><span>// 构建OkHttpClient对象</span></span>
<span class="line"><span>                    .build());</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        @Bean</span></span>
<span class="line"><span>        @Primary</span></span>
<span class="line"><span>        @ConditionalOnBean(LoadBalancerClientFactory.class)</span></span>
<span class="line"><span>        @ConditionalOnMissingBean</span></span>
<span class="line"><span>public LoadBalancerClient blockingLoadBalancerClient(LoadBalancerClientFactory loadBalancerClientFactory) {</span></span>
<span class="line"><span>returnnewBlockingLoadBalancerClient(loadBalancerClientFactory);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>    并且在registerBeanDefinitions生命周期中，实现对客户端注解的解析及配置相关解析，</span></span>
<span class="line"><span>最后对bean对象的自定义注入。(URL的解析会根据配置文件feign.gate-mode，是否整理成网关</span></span>
<span class="line"><span>地址)，具体逻辑如下</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>java</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>package com.kingtsoft.pangu.springcloud.feign;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>/**</span></span>
<span class="line"><span> * Title: &lt;br&gt;</span></span>
<span class="line"><span> * Description: &lt;br&gt;</span></span>
<span class="line"><span> * Company: KingTang &lt;br&gt;</span></span>
<span class="line"><span> *</span></span>
<span class="line"><span> * @author 金炀</span></span>
<span class="line"><span> * @version 1.0</span></span>
<span class="line"><span> */</span></span>
<span class="line"><span>@Slf4j</span></span>
<span class="line"><span>@Configuration</span></span>
<span class="line"><span>public class  PgFeignClientConfigurationimplementsEnvironmentAware, ResourceLoaderAware,</span></span>
<span class="line"><span>ImportBeanDefinitionRegistrar {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private DefaultListableBeanFactory beanFactory;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private final   List&lt;RequestInterceptor&gt; requestInterceptors =new ArrayList&lt;&gt;();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private Contract contract;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private ObjectFactory&lt;HttpMessageConverters&gt; messageConverters;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private ObjectProvider&lt;HttpMessageConverterCustomizer&gt; customizers;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private Client okHttpLoadBalancerClient;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private Client okHttpClient;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private Environment environment;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private ResourceLoader resourceLoader;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>privatestaticfinal List&lt;String&gt; PKG_ARR =new ArrayList&lt;&gt;(Arrays.asList(&quot;**.feign&quot;, &quot;**.api&quot;));</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private String centerUrl;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>privateboolean   gateMode;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private OkHttpCusUrlInterceptor okHttpCusUrlInterceptor;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>private void   setResourceLoader(@NonNull ResourceLoader resourceLoader) {</span></span>
<span class="line"><span>this.resourceLoader = resourceLoader;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>private void   setEnvironment(@NonNull Environment environment) {</span></span>
<span class="line"><span>this.environment = environment;</span></span>
<span class="line"><span>initGatewayUrl();</span></span>
<span class="line"><span>        String lbStr = environment.getProperty(&quot;feign.gate-mode&quot;);</span></span>
<span class="line"><span>this.gateMode = StringUtils.hasText(lbStr) &amp;&amp; boolean  .parseboolean  (lbStr);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private void  initGatewayUrl() {</span></span>
<span class="line"><span>this.centerUrl = System.getProperties().getProperty(HttpConst.CLIENT_ADDR_GATEWAY);</span></span>
<span class="line"><span>if (StringUtils.hasText(centerUrl)) {</span></span>
<span class="line"><span>return;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>this.centerUrl = System.getenv(HttpConst.CLIENT_ADDR_GATEWAY);</span></span>
<span class="line"><span>if (StringUtils.hasText(centerUrl)) {</span></span>
<span class="line"><span>return;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>this.centerUrl = environment.getProperty(HttpConst.CLIENT_ADDR_GATEWAY);</span></span>
<span class="line"><span>if (!StringUtils.hasText(centerUrl)) {</span></span>
<span class="line"><span>this.centerUrl =&quot;http://localhost&quot;;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>private void   registerBeanDefinitions(@NonNull AnnotationMetadata importingClassMetadata,</span></span>
<span class="line"><span>                                        @NonNull BeanDefinitionRegistry registry) {</span></span>
<span class="line"><span>        beanFactory = (DefaultListableBeanFactory) registry;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        PgFeignProperties pgFeignProperties = beanFactory.getBean(PgFeignProperties.class);</span></span>
<span class="line"><span>        PKG_ARR.addAll(pgFeignProperties.getScans());</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        contract = beanFactory.getBean(Contract.class);</span></span>
<span class="line"><span>        messageConverters = beanFactory.getBeanProvider(HttpMessageConverters.class);</span></span>
<span class="line"><span>        customizers = beanFactory.getBeanProvider(HttpMessageConverterCustomizer.class);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        okHttpLoadBalancerClient = (Client) beanFactory.getBean(&quot;okHttpLoadBalancerClient&quot;);</span></span>
<span class="line"><span>        okHttpClient = (Client) beanFactory.getBean(&quot;okHttpFeignClient&quot;);</span></span>
<span class="line"><span>        okHttpCusUrlInterceptor = beanFactory.getBean(OkHttpCusUrlInterceptor.class);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>String[] interBeanNames = beanFactory.getBeanNamesForType(RequestInterceptor.class);</span></span>
<span class="line"><span>for (String beanName : interBeanNames) {</span></span>
<span class="line"><span>            RequestInterceptor interceptor = (RequestInterceptor) beanFactory.getBean(beanName);</span></span>
<span class="line"><span>            requestInterceptors.add(interceptor);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>registerPgFeignClient();</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private void   registerPgFeignClient() {</span></span>
<span class="line"><span>        ClassLoader classLoader = Thread.currentThread().getContextClassLoader();</span></span>
<span class="line"><span>        ClassPathScanningCandidateComponentProvider scanner =getScanner();</span></span>
<span class="line"><span>        scanner.setResourceLoader(this.resourceLoader);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        Set&lt;BeanDefinition&gt; beanDefinitions =new LinkedHashSet&lt;&gt;();</span></span>
<span class="line"><span>for (String pkg : PKG_ARR) {</span></span>
<span class="line"><span>            Set&lt;BeanDefinition&gt; beanDefinitions2 = scanner.findCandidateComponents(pkg);</span></span>
<span class="line"><span>            beanDefinitions.addAll(beanDefinitions2);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>for (BeanDefinition beanDefinition : beanDefinitions) {</span></span>
<span class="line"><span>if (beanDefinition.getBeanClassName() ==null) {</span></span>
<span class="line"><span>continue;</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>try {</span></span>
<span class="line"><span>                beanFactory.getBean(Class.forName(beanDefinition.getBeanClassName()));</span></span>
<span class="line"><span>continue;</span></span>
<span class="line"><span>            } catch (Exception ignored) {</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>try {</span></span>
<span class="line"><span>                Class&lt;?&gt; aClass = classLoader.loadClass(beanDefinition.getBeanClassName());</span></span>
<span class="line"><span>                PgFeignClient pgFeignClient = aClass.getAnnotation(PgFeignClient.class);</span></span>
<span class="line"><span>if (pgFeignClient ==null) {</span></span>
<span class="line"><span>continue;</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// 这里并未实际创建异步客户端，后续考虑升级</span></span>
<span class="line"><span>//                if (pgFeignClient.async()) {</span></span>
<span class="line"><span>//                    AsyncFeign.AsyncBuilder&lt;?&gt; asyncBuilder = beanFactory.getBean(&quot;asyncFeignBuilder&quot;, AsyncFeign.AsyncBuilder.class);</span></span>
<span class="line"><span>//                }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                Feign.Builder relBuild;</span></span>
<span class="line"><span>switch (pgFeignClient.encoder()) {</span></span>
<span class="line"><span>case GSON:</span></span>
<span class="line"><span>                        relBuild =pgFeignGsonBuild();</span></span>
<span class="line"><span>break;</span></span>
<span class="line"><span>case FORM:</span></span>
<span class="line"><span>                        relBuild =pgFeignFormBuild();</span></span>
<span class="line"><span>break;</span></span>
<span class="line"><span>default:</span></span>
<span class="line"><span>                        relBuild =pgFeignBuild();</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                String url;</span></span>
<span class="line"><span>if (StringUtils.hasText(pgFeignClient.url())) {</span></span>
<span class="line"><span>                    url = pgFeignClient.url();</span></span>
<span class="line"><span>if (url.contains(&quot;${&quot;) &amp;&amp; url.contains(&quot;}&quot;)) {</span></span>
<span class="line"><span>                        url = environment.resolvePlaceholders(pgFeignClient.url());</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (url.equals(pgFeignClient.url())) {</span></span>
<span class="line"><span>                            url =getUrlByClientCode(pgFeignClient.clientCode(), pgFeignClient.basePath());</span></span>
<span class="line"><span>                        }</span></span>
<span class="line"><span>                    }</span></span>
<span class="line"><span>                } else {</span></span>
<span class="line"><span>                    url =getUrlByClientCode(pgFeignClient.clientCode(), pgFeignClient.basePath());</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// 指定</span></span>
<span class="line"><span>if (pgFeignClient.loadBalance()) {</span></span>
<span class="line"><span>                    relBuild.client(okHttpLoadBalancerClient);</span></span>
<span class="line"><span>                } else {</span></span>
<span class="line"><span>                    relBuild.client(okHttpClient);</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// 如果检测到地址是个IP，强制非负载方式</span></span>
<span class="line"><span>UrlCheck(relBuild, url);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (!StringUtils.hasText(url)) {</span></span>
<span class="line"><span>                    url =&quot;http://localhost&quot;;</span></span>
<span class="line"><span>                    log.warn(&quot;注意：{}客户端无法匹配具体url地址!&quot;, beanDefinition.getBeanClassName());</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                url = PgFeignUtil.doOptimization(url);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>registerBeanDefinition(beanFactory, beanDefinition.getBeanClassName());</span></span>
<span class="line"><span>initConfiguration(relBuild, pgFeignClient.configuration(), pgFeignClient.clientCode());</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                beanFactory.registerSingleton(beanDefinition.getBeanClassName(),</span></span>
<span class="line"><span>                        relBuild.target(aClass, url)</span></span>
<span class="line"><span>                );</span></span>
<span class="line"><span>            } catch (Exception e) {</span></span>
<span class="line"><span>                log.error(&quot;feign初始化异常&quot;, e);</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private void  UrlCheck(Feign.Builder relBuild, String url) {</span></span>
<span class="line"><span>try {</span></span>
<span class="line"><span>            URI uri = URI.create(url);</span></span>
<span class="line"><span>if (isIp(uri.getHost()) ||&quot;localhost&quot;.equals(uri.getHost())) {</span></span>
<span class="line"><span>                relBuild.client(okHttpClient);</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        } catch (Exception ignore) {}</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>publicstaticboolean  isIp(String addr) {</span></span>
<span class="line"><span>if (addr.length() &lt;7|| addr.length() &gt;15) {</span></span>
<span class="line"><span>returnfalse;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        String rexp =&quot;([1-9]|[1-9]\\d|1\\d{2}|2[0-4]\\d|25[0-5])(\\.(\\d|[1-9]\\d|1\\d{2}|2[0-4]\\d|25[0-5])){3}&quot;;</span></span>
<span class="line"><span>        Pattern pat = Pattern.compile(rexp);</span></span>
<span class="line"><span>        Matcher mat = pat.matcher(addr);</span></span>
<span class="line"><span>return mat.find();</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @SneakyThrows</span></span>
<span class="line"><span>private void  initConfiguration(Feign.Builder relBuild, Class&lt;?&gt;[] configuration, String clientCode) {</span></span>
<span class="line"><span>for (Class&lt;?&gt; clazz : configuration) {</span></span>
<span class="line"><span>for (Method method : clazz.getMethods()) {</span></span>
<span class="line"><span>                Bean bean = AnnotatedElementUtils.findMergedAnnotation(method, Bean.class);</span></span>
<span class="line"><span>if (bean ==null) {</span></span>
<span class="line"><span>continue;</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                Object ret = bean.value().length ==0?</span></span>
<span class="line"><span>                        beanFactory.getBean(method.getName()) :</span></span>
<span class="line"><span>                        beanFactory.getBean(bean.value()[0]);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>pkgFeignBuild(relBuild, method.getReturnType(), ret);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (FeignUrlCusApi.class.isAssignableFrom(method.getReturnType())) {</span></span>
<span class="line"><span>if (StringUtils.hasText(clientCode)) {</span></span>
<span class="line"><span>                        okHttpCusUrlInterceptor.addFeignUrlCusApi(clientCode, (FeignUrlCusApi) ret);</span></span>
<span class="line"><span>                    }</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private void  pkgFeignBuild(Feign.Builder relBuild, Class&lt;?&gt; returnType, Object ret) {</span></span>
<span class="line"><span>if (Encoder.class.isAssignableFrom(returnType)) {</span></span>
<span class="line"><span>            relBuild.encoder((Encoder) ret);</span></span>
<span class="line"><span>return;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>if (Decoder.class.isAssignableFrom(returnType)) {</span></span>
<span class="line"><span>            relBuild.decoder((Decoder) ret);</span></span>
<span class="line"><span>return;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>if (Contract.class.isAssignableFrom(returnType)) {</span></span>
<span class="line"><span>            relBuild.contract((Contract) ret);</span></span>
<span class="line"><span>return;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>if (Client.class.isAssignableFrom(returnType)) {</span></span>
<span class="line"><span>            relBuild.client((Client) ret);</span></span>
<span class="line"><span>return;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>if (Retryer.class.isAssignableFrom(returnType)) {</span></span>
<span class="line"><span>            relBuild.retryer((Retryer) ret);</span></span>
<span class="line"><span>return;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>if (Request.Options.class.isAssignableFrom(returnType)) {</span></span>
<span class="line"><span>            relBuild.options((Request.Options) ret);</span></span>
<span class="line"><span>return;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>if (RequestInterceptor.class.isAssignableFrom(returnType)) {</span></span>
<span class="line"><span>            relBuild.requestInterceptor((RequestInterceptor) ret);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private String getUrlByClientCode(String clientCode, String basePath) {</span></span>
<span class="line"><span>if (StringUtils.hasText(clientCode)) {</span></span>
<span class="line"><span>if (!this.gateMode) {</span></span>
<span class="line"><span>return&quot;http://&quot;+ clientCode + (StringUtils.hasText(basePath) ?&quot;/&quot;+ basePath :&quot;&quot;);</span></span>
<span class="line"><span>            } else {</span></span>
<span class="line"><span>return centerUrl +&quot;/&quot;+ (StringUtils.hasText(basePath) ? basePath : clientCode);</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>return StringUtils.hasText(basePath) ? centerUrl +&quot;/&quot;+ basePath : centerUrl;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>protected ClassPathScanningCandidateComponentProvider getScanner() {</span></span>
<span class="line"><span>returnnewClassPathScanningCandidateComponentProvider(false, this.environment) {</span></span>
<span class="line"><span>            @Override</span></span>
<span class="line"><span>protectedboolean  isCandidateComponent(@NonNull MetadataReader metadataReader) {</span></span>
<span class="line"><span>                Optional&lt;String&gt; target = metadataReader.getAnnotationMetadata().getAnnotationTypes().stream().filter(</span></span>
<span class="line"><span>                        sn -&gt; sn.equals(PgFeignClient.class.getName())</span></span>
<span class="line"><span>                ).findAny();</span></span>
<span class="line"><span>return target.isPresent();</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            @Override</span></span>
<span class="line"><span>protectedboolean  isCandidateComponent(@NonNull AnnotatedBeanDefinition beanDefinition) {</span></span>
<span class="line"><span>return beanDefinition.getMetadata().isInterface() &amp;&amp;!beanDefinition.getMetadata().isAnnotation();</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        };</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private void  registerBeanDefinition(DefaultListableBeanFactory beanFactory, String name) {</span></span>
<span class="line"><span>        BeanDefinitionBuilder beanDefinitionBuilder = BeanDefinitionBuilder.genericBeanDefinition(Binding.class);</span></span>
<span class="line"><span>        beanDefinitionBuilder.addPropertyReference(name, name);</span></span>
<span class="line"><span>        BeanDefinition beanDefinition = beanDefinitionBuilder.getRawBeanDefinition();</span></span>
<span class="line"><span>        beanFactory.registerBeanDefinition(name, beanDefinition);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>public Feign.Builder pgFeignBuild() {</span></span>
<span class="line"><span>        Feign.Builder builder =getFeignBuildDefault();</span></span>
<span class="line"><span>buildInterceptors(builder);</span></span>
<span class="line"><span>        String wn = environment.getProperty(&quot;feign.write-nulls&quot;);</span></span>
<span class="line"><span>boolean   writeNulls = StringUtils.hasText(wn) &amp;&amp; boolean  .parseboolean  (wn);</span></span>
<span class="line"><span>// 使用fastjson作为feign的消息转换器</span></span>
<span class="line"><span>        ObjectFactory&lt;HttpMessageConverters&gt; feignObjectFactory = PgFeignUtil.initFeignNewConverters(messageConverters, writeNulls);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>return builder</span></span>
<span class="line"><span>                .contract(contract)</span></span>
<span class="line"><span>                .encoder(newSpringEncoder(feignObjectFactory))</span></span>
<span class="line"><span>                .decoder(newSpringDecoder(feignObjectFactory, customizers));</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>public Feign.Builder pgFeignGsonBuild() {</span></span>
<span class="line"><span>        Feign.Builder builder =getFeignBuildDefault();</span></span>
<span class="line"><span>buildInterceptors(builder);</span></span>
<span class="line"><span>return builder</span></span>
<span class="line"><span>                .contract(contract)</span></span>
<span class="line"><span>                .encoder(newGsonEncoder())</span></span>
<span class="line"><span>                .decoder(newGsonDecoder());</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>public Feign.Builder pgFeignFormBuild() {</span></span>
<span class="line"><span>        Feign.Builder builder =getFeignBuildDefault();</span></span>
<span class="line"><span>buildInterceptors(builder);</span></span>
<span class="line"><span>        String wn = environment.getProperty(&quot;feign.write-nulls&quot;);</span></span>
<span class="line"><span>boolean   writeNulls = StringUtils.hasText(wn) &amp;&amp; boolean  .parseboolean  (wn);</span></span>
<span class="line"><span>// 使用fastjson作为feign的消息转换器</span></span>
<span class="line"><span>        ObjectFactory&lt;HttpMessageConverters&gt; feignObjectFactory = PgFeignUtil.initFeignNewConverters(messageConverters, writeNulls);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>return builder</span></span>
<span class="line"><span>                .contract(contract)</span></span>
<span class="line"><span>                .encoder(newSpringFormEncoder(newSpringEncoder(feignObjectFactory)))</span></span>
<span class="line"><span>                .decoder(newSpringDecoder(feignObjectFactory, customizers));</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private Feign.Builder getFeignBuildDefault() {</span></span>
<span class="line"><span>// 因为scope为prototype，每次获取bean都会重新创建一个新对象</span></span>
<span class="line"><span>return beanFactory.getBean(&quot;feignBuilder&quot;, Feign.Builder.class);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private void  buildInterceptors(Feign.Builder builder) {</span></span>
<span class="line"><span>// 不直接使用builder.requestInterceptors方法的原因是这个方法会清空原有拦截器</span></span>
<span class="line"><span>for (RequestInterceptor requestInterceptor : requestInterceptors) {</span></span>
<span class="line"><span>            builder.requestInterceptor(requestInterceptor);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>    主要给feign客户端配置了各类拦截编码及响应值解析所需缓存（因为feign的回调钩子</span></span>
<span class="line"><span>上下文中无法获取到执行的方法上下文，也就无法知道使用哪个值转换类，所以需要提前缓存好）。</span></span>
<span class="line"><span>主要使用了反射。此时客户端已经生成。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>java</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>package com.kingtsoft.pangu.springcloud.feign;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>import com.kingtsoft.pangu.springcloud.feign.annotation.FeignResultClient;</span></span>
<span class="line"><span>import com.kingtsoft.pangu.springcloud.feign.annotation.PgFeignClient;</span></span>
<span class="line"><span>import com.kingtsoft.pangu.springcloud.feign.utils.PgFeignUtil;</span></span>
<span class="line"><span>import org.springframework.beans.BeansException;</span></span>
<span class="line"><span>import org.springframework.context.ApplicationContext;</span></span>
<span class="line"><span>import org.springframework.context.ApplicationContextAware;</span></span>
<span class="line"><span>import org.springframework.core.annotation.AnnotatedElementUtils;</span></span>
<span class="line"><span>import org.springframework.lang.NonNull;</span></span>
<span class="line"><span>import org.springframework.stereotype.Component;</span></span>
<span class="line"><span>import org.springframework.util.StringUtils;</span></span>
<span class="line"><span>import org.springframework.web.bind.annotation.RequestMapping;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>import java.lang.reflect.*;</span></span>
<span class="line"><span>import java.net.URI;</span></span>
<span class="line"><span>import java.util.HashMap;</span></span>
<span class="line"><span>import java.util.Map;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>/**</span></span>
<span class="line"><span> * Title: &lt;br&gt;</span></span>
<span class="line"><span> * Description: &lt;br&gt;</span></span>
<span class="line"><span> * Company: KingTang &lt;br&gt;</span></span>
<span class="line"><span> *</span></span>
<span class="line"><span> * @author 金炀</span></span>
<span class="line"><span> * @version 1.0</span></span>
<span class="line"><span> */</span></span>
<span class="line"><span>@Component</span></span>
<span class="line"><span>public class  FeignResultCoverRegisterimplementsApplicationContextAware {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private final   Map&lt;String, FeignResultCover&gt; feignResultCache =new HashMap&lt;&gt;();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private ApplicationContext applicationContext;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>private void   setApplicationContext(@NonNull ApplicationContext applicationContext) throws BeansException {</span></span>
<span class="line"><span>this.applicationContext = applicationContext;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private void   registerFeignResultCover() {</span></span>
<span class="line"><span>        Map&lt;String, Object&gt; feignResultBeans = applicationContext.getBeansWithAnnotation(PgFeignClient.class);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        feignResultBeans.forEach(</span></span>
<span class="line"><span>                (beanName, bean) -&gt; {</span></span>
<span class="line"><span>if (Proxy.isProxyClass(bean.getClass())) {</span></span>
<span class="line"><span>                        Object obj = Proxy.getInvocationHandler(bean);</span></span>
<span class="line"><span>try {</span></span>
<span class="line"><span>                            Field targetField = obj.getClass().getDeclaredField(&quot;target&quot;);</span></span>
<span class="line"><span>                            targetField.setAccessible(true);</span></span>
<span class="line"><span>                            Object target = targetField.get(obj);</span></span>
<span class="line"><span>if (target ==null) {</span></span>
<span class="line"><span>thrownewRuntimeException(&quot;代理 target属性缺失: &quot;+ obj.getClass().getName());</span></span>
<span class="line"><span>                            }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                            Field urlField = target.getClass().getDeclaredField(&quot;url&quot;);</span></span>
<span class="line"><span>                            urlField.setAccessible(true);</span></span>
<span class="line"><span>                            String reqUrl = (String) urlField.get(target);</span></span>
<span class="line"><span>if (reqUrl ==null) {</span></span>
<span class="line"><span>                                reqUrl =&quot;&quot;;</span></span>
<span class="line"><span>                            }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                            Field typeField = target.getClass().getDeclaredField(&quot;type&quot;);</span></span>
<span class="line"><span>                            typeField.setAccessible(true);</span></span>
<span class="line"><span>                            Class&lt;?&gt; type = (Class&lt;?&gt;) typeField.get(target);</span></span>
<span class="line"><span>if (type ==null) {</span></span>
<span class="line"><span>thrownewRuntimeException(&quot;type属性缺失: &quot;+ target.getClass().getName());</span></span>
<span class="line"><span>                            }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                            PgFeignClient client = type.getAnnotation(PgFeignClient.class);</span></span>
<span class="line"><span>if (client !=null&amp;&amp;!StringUtils.hasText(reqUrl)) {</span></span>
<span class="line"><span>                                reqUrl = client.clientCode();</span></span>
<span class="line"><span>                            }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                            FeignResultClient parentAnnotation = type.getAnnotation(FeignResultClient.class);</span></span>
<span class="line"><span>                            FeignResultCover parentResultCover =null;</span></span>
<span class="line"><span>if (parentAnnotation !=null) {</span></span>
<span class="line"><span>                                parentResultCover =</span></span>
<span class="line"><span>newFeignResultCover(parentAnnotation.value(), parentAnnotation.coverMethod(), null);</span></span>
<span class="line"><span>                            }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>String[] parentUrls =getMethodUrl(type);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Method[] methods = type.getDeclaredMethods();</span></span>
<span class="line"><span>for (Method method : methods) {</span></span>
<span class="line"><span>                                FeignResultClient annotation = method.getAnnotation(FeignResultClient.class);</span></span>
<span class="line"><span>                                FeignResultCover resultCover;</span></span>
<span class="line"><span>                                String postfix;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (annotation !=null) {</span></span>
<span class="line"><span>                                    postfix = annotation.postfix();</span></span>
<span class="line"><span>                                    resultCover =newFeignResultCover(</span></span>
<span class="line"><span>                                            annotation.value(), annotation.coverMethod(), method.getReturnType());</span></span>
<span class="line"><span>                                } else {</span></span>
<span class="line"><span>                                    postfix =&quot;&quot;;</span></span>
<span class="line"><span>if (parentResultCover ==null) {</span></span>
<span class="line"><span>continue;</span></span>
<span class="line"><span>                                    }</span></span>
<span class="line"><span>                                    resultCover =newFeignResultCover(</span></span>
<span class="line"><span>                                            parentResultCover.getCoverClazz(),</span></span>
<span class="line"><span>                                            parentResultCover.getCoverMethod(),</span></span>
<span class="line"><span>                                            method.getReturnType());</span></span>
<span class="line"><span>                                }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>String[] urls =getMethodUrl(method);</span></span>
<span class="line"><span>if (method.getParameterTypes().length !=0&amp;&amp; method.getParameterTypes()[0].equals(URI.class)) {</span></span>
<span class="line"><span>if (urls !=null) {</span></span>
<span class="line"><span>for (String url : urls) {</span></span>
<span class="line"><span>                                            feignResultCache.put(PgFeignUtil.doOptimization(&quot;**/&quot;+ url + postfix), resultCover);</span></span>
<span class="line"><span>                                        }</span></span>
<span class="line"><span>                                    } else {</span></span>
<span class="line"><span>                                        feignResultCache.put(PgFeignUtil.doOptimization(&quot;**/&quot;+ postfix), resultCover);</span></span>
<span class="line"><span>                                    }</span></span>
<span class="line"><span>                                } else {</span></span>
<span class="line"><span>if (parentUrls ==null|| parentUrls.length ==0) {</span></span>
<span class="line"><span>if (urls !=null) {</span></span>
<span class="line"><span>for (String url : urls) {</span></span>
<span class="line"><span>                                                feignResultCache.put(PgFeignUtil.doOptimization(reqUrl + url + postfix), resultCover);</span></span>
<span class="line"><span>                                            }</span></span>
<span class="line"><span>                                        }</span></span>
<span class="line"><span>                                    } else {</span></span>
<span class="line"><span>for (String parentUrl : parentUrls) {</span></span>
<span class="line"><span>if (urls !=null) {</span></span>
<span class="line"><span>for (String url : urls) {</span></span>
<span class="line"><span>                                                    feignResultCache.put(PgFeignUtil.doOptimization(reqUrl + parentUrl + url + postfix), resultCover);</span></span>
<span class="line"><span>                                                }</span></span>
<span class="line"><span>                                            } else {</span></span>
<span class="line"><span>                                                feignResultCache.put(PgFeignUtil.doOptimization(reqUrl + parentUrl + postfix), resultCover);</span></span>
<span class="line"><span>                                            }</span></span>
<span class="line"><span>                                        }</span></span>
<span class="line"><span>                                    }</span></span>
<span class="line"><span>                                }</span></span>
<span class="line"><span>                            }</span></span>
<span class="line"><span>                        } catch (Exception e) {</span></span>
<span class="line"><span>                            e.printStackTrace();</span></span>
<span class="line"><span>                        }</span></span>
<span class="line"><span>                    }</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>        );</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>public Map&lt;String, FeignResultCover&gt; getFeignResultCache() {</span></span>
<span class="line"><span>returnthis.feignResultCache;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>privateString[] getMethodUrl(AnnotatedElement element) {</span></span>
<span class="line"><span>        RequestMapping requestMapping = AnnotatedElementUtils.findMergedAnnotation(element, RequestMapping.class);</span></span>
<span class="line"><span>if (requestMapping !=null) {</span></span>
<span class="line"><span>return requestMapping.value();</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>returnnull;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>    通过缓存，加入了自动对jsonresult的数据解析及内容判定，在调用及定义的时候可以直接定义</span></span>
<span class="line"><span>结构体data内的数据，不需要每次都写显示的代码，对内容进行解析。当然并不是所有接口都一定需要</span></span>
<span class="line"><span>解析结构体，所以需要一个FeignResultClient注解，标记此类客户端(不同结构体的解析器是可以</span></span>
<span class="line"><span>自定义的，并配置到FeignResultClient中)。拦截器解析如下：</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>java</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>@Override</span></span>
<span class="line"><span>    @NonNull</span></span>
<span class="line"><span>public Response intercept(Chain chain) throws IOException {</span></span>
<span class="line"><span>//这个chain里面包含了request和response，所以你要什么都可以从这里拿</span></span>
<span class="line"><span>        Request request = chain.request();</span></span>
<span class="line"><span>//请求发起的时间</span></span>
<span class="line"><span>        Response response = chain.proceed(request);</span></span>
<span class="line"><span>if (response.code() &gt;=400) {</span></span>
<span class="line"><span>            String msg = StringUtils.hasText(response.message()) ?</span></span>
<span class="line"><span>                    response.message() :</span></span>
<span class="line"><span>                    (response.body() ==null?&quot;&quot;: response.body().string());</span></span>
<span class="line"><span>if (log.isDebugEnabled()) {</span></span>
<span class="line"><span>                log.debug(&quot;code: {} msg: {}&quot;, response.code(), msg);</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>thrownewTipException(response.code(), msg);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        ResponseBody body = response.body();</span></span>
<span class="line"><span>if (body ==null) {</span></span>
<span class="line"><span>return response;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        FeignResultCover resultCover =getFeignResultCover(request.url().toString());</span></span>
<span class="line"><span>if (resultCover ==null) {</span></span>
<span class="line"><span>return response;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        String ret = body.string();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        Class&lt;?&gt; clazz = resultCover.getCoverClazz();</span></span>
<span class="line"><span>        Method method;</span></span>
<span class="line"><span>        Object obj;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>try {</span></span>
<span class="line"><span>            method = clazz.getMethod(resultCover.getCoverMethod(), Object.class);</span></span>
<span class="line"><span>            obj = method.invoke(clazz.getDeclaredConstructor().newInstance(), ret);</span></span>
<span class="line"><span>        } catch (InvocationTargetException e) {</span></span>
<span class="line"><span>if (log.isDebugEnabled()) {</span></span>
<span class="line"><span>                e.printStackTrace();</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>            Throwable exception = e.getTargetException();</span></span>
<span class="line"><span>if (exception instanceof TipException) {</span></span>
<span class="line"><span>throw (TipException) exception;</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>thrownewTipException(e.toString());</span></span>
<span class="line"><span>        } catch (NoSuchMethodException | IllegalAccessException | InstantiationException e) {</span></span>
<span class="line"><span>if (log.isDebugEnabled()) {</span></span>
<span class="line"><span>                e.printStackTrace();</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>thrownewTipException(e.toString());</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        ResponseBody bodyNew;</span></span>
<span class="line"><span>        String bkObj;</span></span>
<span class="line"><span>if (obj ==null) {</span></span>
<span class="line"><span>            bkObj =&quot;null&quot;;</span></span>
<span class="line"><span>        } elseif (obj.getClass().equals(String.class)) {</span></span>
<span class="line"><span>// 会使用消息转换器切换回来</span></span>
<span class="line"><span>            bkObj = JSON.toJSONString(obj);</span></span>
<span class="line"><span>        } else {</span></span>
<span class="line"><span>            bkObj = JSON.toJSONString(obj);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        bodyNew = ResponseBody.create(body.contentType(), bkObj);</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>return response.newBuilder().body(bodyNew).build();</span></span>
<span class="line"><span>    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>    支持服务自定义代码返回地址（用于三方，可能需要数据库动态实时获取），原理是利用拦截器</span></span>
<span class="line"><span>对request进行地址截取并填充新数据。业务端实现FeignUrlCusApi接口，重写方法就行。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>java</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>public class  OkHttpCusUrlInterceptorimplementsInterceptor {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private final   Map&lt;String, FeignUrlCusApi&gt; urlCusApis =new LinkedHashMap&lt;&gt;();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private void   addFeignUrlCusApi(String serviceId, FeignUrlCusApi feignUrlCusApi) {</span></span>
<span class="line"><span>this.urlCusApis.put(serviceId, feignUrlCusApi);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @NonNull</span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>public Response intercept(@NonNull Chain chain) throws IOException {</span></span>
<span class="line"><span>try {</span></span>
<span class="line"><span>            String path = chain.request().url().encodedPath();</span></span>
<span class="line"><span>            Request request = chain.request();</span></span>
<span class="line"><span>            FeignUrlCusApi urlCusApi = urlCusApis.get(request.url().host());</span></span>
<span class="line"><span>if (urlCusApi ==null) {</span></span>
<span class="line"><span>return chain.proceed(request);</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            String url = urlCusApi.getUrl();</span></span>
<span class="line"><span>if (!StringUtils.hasText(url)) {</span></span>
<span class="line"><span>return chain.proceed(request);</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            HttpUrl httpUrl = Objects.requireNonNull(request.url().newBuilder(url + path))</span></span>
<span class="line"><span>                    .query(request.url().query())</span></span>
<span class="line"><span>                    .encodedQuery(request.url().encodedQuery())</span></span>
<span class="line"><span>                    .fragment(request.url().fragment())</span></span>
<span class="line"><span>                    .encodedFragment(request.url().encodedFragment())</span></span>
<span class="line"><span>                    .build();</span></span>
<span class="line"><span>return chain.proceed(request.newBuilder().url(httpUrl).build());</span></span>
<span class="line"><span>        } catch (Exception e) {</span></span>
<span class="line"><span>            log.error(e.toString());</span></span>
<span class="line"><span>return chain.proceed(chain.request());</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>Feign-java调用兼容</span></span>
<span class="line"><span>    添加了feign API的spring bean判断，若当前接口中存在对应的实现，将不会对此接口进行</span></span>
<span class="line"><span>feign客户端的代理生成，常规的接口调用将变成进程内的直接调用【自然可以保持直接的事务一致】。</span></span>
<span class="line"><span>若不存在实现，则接口就会执行注解所示的feign调用。这个时候就会需要使用分布式事务。 接口所处</span></span>
<span class="line"><span>目录要么包名带feign，要么带api关键字</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="http://pangu.kingtsoft.com/pangu-facade/assets/image1.8ca381d0.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>负载均衡</span></span>
<span class="line"><span>    回到自动化配置类初始化内容FeignAutoConfiguration</span></span>
<span class="line"><span>    可以看到配置了</span></span>
<span class="line"><span>@AutoConfigureAfter(name = {&quot;com.kingtsoft.pangu.springcloud.nacos.NacosAutoConfiguration&quot;})，</span></span>
<span class="line"><span>    主要是结合nacos模块，由于需要引入自定义的loadbalance模块进行堵在均衡自定义算法执行。</span></span>
<span class="line"><span>所以需要在NacosAutoConfiguration配置负载客户端之后加载，因为是字符串引入，所以两个</span></span>
<span class="line"><span>模块不是强耦合的，如果没有LoadBalancerClientFactory 中的configurations只是没有</span></span>
<span class="line"><span>了自定义的负载实现，会走默认。NacosAutoConfiguration先执行就是为了让</span></span>
<span class="line"><span>LoadBalancerClientFactory可以提前往configurations注入自定义的实现。okHttp的负</span></span>
<span class="line"><span>载客户端这里直接默认使用了BlockingLoadBalancerClient，LoadBalancerClientFactory</span></span>
<span class="line"><span>的初始都参考源码内容。并且开放了集群标记配置，这样在没有网关的情况下，feign也能独立完成</span></span>
<span class="line"><span>流量的引导。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/Todreamr/Dr.Magic/edit/main/src/盘古/组件介绍/盘古-security.md" aria-label="在 GitHub 上编辑此页" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">上次编辑于: </span><!----></div><div class="contributors"><span class="vp-meta-label">贡献者: </span><!--[--><!--[--><span class="vp-meta-info" title="email: aruixrain@gmail.com">九歌天上有</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/%E5%BB%B6%E6%97%B6%E6%A8%A1%E5%9D%97.html" aria-label="Delay模块"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->Delay模块</div></a><a class="route-link auto-link next" href="/%E7%9B%98%E5%8F%A4/%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/Https%E6%A8%A1%E5%9D%97.html" aria-label="Https模块"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">Https模块<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">由萌ICP备案</div><div class="vp-copyright">Copyright © Mr.Cotton Eye Joe</div></footer></div><!--]--><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-TmqSDitQ.js" defer></script>
  </body>
</html>
